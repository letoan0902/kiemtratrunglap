<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - H·ªá th·ªëng Ki·ªÉm tra Tr√πng l·∫∑p</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- SheetJS Library for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <div class="nav-brand">üß° Admin Panel</div>
            <div class="nav-links">
                <span id="userInfo" class="nav-link"></span>
                <a href="#" id="logoutBtn" class="nav-link">ƒêƒÉng xu·∫•t</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Statistics -->
        <div class="stats" id="statsContainer">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Ng∆∞·ªùi d√πng</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalFields">0</div>
                <div class="stat-label">Tr∆∞·ªùng d·ªØ li·ªáu</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalData">0</div>
                <div class="stat-label">T·ªïng d·ªØ li·ªáu</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalDuplicates">0</div>
                <div class="stat-label">Tr√πng l·∫∑p</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" style="margin-bottom: 30px; border-bottom: 2px solid #ffb380;">
            <button class="tab-btn active" data-tab="users">üë• Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</button>
            <button class="tab-btn" data-tab="fields">üìä Qu·∫£n l√Ω Tr∆∞·ªùng</button>
            <button class="tab-btn" data-tab="data">üíæ Xem D·ªØ li·ªáu</button>
            <button class="tab-btn" data-tab="userdata">üë§ Ki·ªÉm tra User Data</button>
            <button class="tab-btn" data-tab="export">üì§ Xu·∫•t d·ªØ li·ªáu</button>
        </div>

        <!-- Users Tab -->
        <div class="tab-content active" id="tab-users">
            <div class="dashboard-container">
                <div class="card-header">
                    <h2 class="card-title">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h2>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="search-container">
                            <input type="text" id="userSearchBox" class="form-input search-input" placeholder="üîç T√¨m ki·∫øm ng∆∞·ªùi d√πng..." style="width: 250px; margin: 0;" autocomplete="off">
                            <button class="search-clear-btn" id="userSearchClear" title="X√≥a t√¨m ki·∫øm">√ó</button>
                        </div>
                        <button class="btn btn-primary" id="addUserBtn">‚ûï Th√™m ng∆∞·ªùi d√πng</button>
                    </div>
                </div>
                
                <!-- Column Search Row -->
                <div class="column-search-container" id="userColumnSearch" style="display: none;">
                    <div class="column-search-grid">
                        <div class="column-search-item">
                            <label>T√™n:</label>
                            <div class="search-container">
                                <input type="text" class="column-search-input" data-column="0" placeholder="T√¨m theo t√™n..." autocomplete="off">
                                <button class="search-clear-btn" onclick="this.previousElementSibling.value=''; this.closest('.column-search-container').dispatchEvent(new Event('search'));">√ó</button>
                            </div>
                        </div>
                        <div class="column-search-item">
                            <label>Email:</label>
                            <div class="search-container">
                                <input type="text" class="column-search-input" data-column="1" placeholder="T√¨m theo email..." autocomplete="off">
                                <button class="search-clear-btn" onclick="this.previousElementSibling.value=''; this.closest('.column-search-container').dispatchEvent(new Event('search'));">√ó</button>
                            </div>
                        </div>
                        <div class="column-search-item">
                            <label>Ng√†y t·∫°o:</label>
                            <div class="search-container">
                                <input type="text" class="column-search-input" data-column="3" placeholder="T√¨m theo ng√†y..." autocomplete="off">
                                <button class="search-clear-btn" onclick="this.previousElementSibling.value=''; this.closest('.column-search-container').dispatchEvent(new Event('search'));">√ó</button>
                            </div>
                        </div>
                        <div class="column-search-item">
                            <label>T·∫°o b·ªüi:</label>
                            <div class="search-container">
                                <input type="text" class="column-search-input" data-column="4" placeholder="T√¨m theo ng∆∞·ªùi t·∫°o..." autocomplete="off">
                                <button class="search-clear-btn" onclick="this.previousElementSibling.value=''; this.closest('.column-search-container').dispatchEvent(new Event('search'));">√ó</button>
                            </div>
                        </div>
                        <div class="column-search-actions">
                            <button class="btn btn-secondary btn-sm" onclick="adminPanel.clearAllColumnSearch('userColumnSearch')">X√≥a t·∫•t c·∫£</button>
                            <button class="btn btn-secondary btn-sm" onclick="adminPanel.hideColumnSearch('userColumnSearch')">·∫®n</button>
                        </div>
                    </div>
                </div>
                
                <div id="usersTableContainer">
                    <!-- Users table will be generated here -->
                </div>
            </div>
        </div>

        <!-- Fields Tab -->
        <div class="tab-content" id="tab-fields">
            <div class="dashboard-container">
                <div class="card-header">
                    <h2 class="card-title">Qu·∫£n l√Ω Tr∆∞·ªùng D·ªØ li·ªáu</h2>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="search-container">
                            <input type="text" id="fieldSearchBox" class="form-input search-input" placeholder="üîç T√¨m ki·∫øm tr∆∞·ªùng..." style="width: 250px; margin: 0;" autocomplete="off">
                            <button class="search-clear-btn" id="fieldSearchClear" title="X√≥a t√¨m ki·∫øm">√ó</button>
                        </div>
                        <button class="btn btn-primary" id="addFieldBtn">‚ûï Th√™m tr∆∞·ªùng</button>
                    </div>
                </div>
                
                <!-- Column Search Row -->
                <div class="column-search-container" id="fieldColumnSearch" style="display: none;">
                    <div class="column-search-grid">
                        <div class="column-search-item">
                            <label>T√™n tr∆∞·ªùng:</label>
                            <div class="search-container">
                                <input type="text" class="column-search-input" data-column="0" placeholder="T√¨m theo t√™n..." autocomplete="off">
                                <button class="search-clear-btn" onclick="this.previousElementSibling.value=''; this.closest('.column-search-container').dispatchEvent(new Event('search'));">√ó</button>
                            </div>
                        </div>
                        <div class="column-search-item">
                            <label>M√¥ t·∫£:</label>
                            <div class="search-container">
                                <input type="text" class="column-search-input" data-column="1" placeholder="T√¨m theo m√¥ t·∫£..." autocomplete="off">
                                <button class="search-clear-btn" onclick="this.previousElementSibling.value=''; this.closest('.column-search-container').dispatchEvent(new Event('search'));">√ó</button>
                            </div>
                        </div>
                        <div class="column-search-item">
                            <label>Ng√†y t·∫°o:</label>
                            <div class="search-container">
                                <input type="text" class="column-search-input" data-column="4" placeholder="T√¨m theo ng√†y..." autocomplete="off">
                                <button class="search-clear-btn" onclick="this.previousElementSibling.value=''; this.closest('.column-search-container').dispatchEvent(new Event('search'));">√ó</button>
                            </div>
                        </div>
                        <div class="column-search-item">
                            <label>T·∫°o b·ªüi:</label>
                            <div class="search-container">
                                <input type="text" class="column-search-input" data-column="5" placeholder="T√¨m theo ng∆∞·ªùi t·∫°o..." autocomplete="off">
                                <button class="search-clear-btn" onclick="this.previousElementSibling.value=''; this.closest('.column-search-container').dispatchEvent(new Event('search'));">√ó</button>
                            </div>
                        </div>
                        <div class="column-search-actions">
                            <button class="btn btn-secondary btn-sm" onclick="adminPanel.clearAllColumnSearch('fieldColumnSearch')">X√≥a t·∫•t c·∫£</button>
                            <button class="btn btn-secondary btn-sm" onclick="adminPanel.hideColumnSearch('fieldColumnSearch')">·∫®n</button>
                        </div>
                    </div>
                </div>
                
                <div id="fieldsTableContainer">
                    <!-- Fields table will be generated here -->
                </div>
            </div>
        </div>

        <!-- Data Tab -->
        <div class="tab-content" id="tab-data">
            <div class="dashboard-container">
                <div class="card-header">
                    <h2 class="card-title">Xem D·ªØ li·ªáu Theo Tr∆∞·ªùng</h2>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="search-container">
                            <input type="text" id="dataSearchBox" class="form-input search-input" placeholder="üîç T√¨m ki·∫øm d·ªØ li·ªáu..." style="width: 250px; margin: 0;" autocomplete="off">
                            <button class="search-clear-btn" id="dataSearchClear" title="X√≥a t√¨m ki·∫øm">√ó</button>
                        </div>
                        <div class="custom-select" id="fieldSelectContainer">
                            <div class="select-trigger" id="fieldSelectTrigger">
                                <span>Ch·ªçn tr∆∞·ªùng ƒë·ªÉ xem</span>
                                <span class="arrow">‚ñº</span>
                            </div>
                            <ul class="select-options" id="fieldSelectOptions">
                                <li data-value="">Ch·ªçn tr∆∞·ªùng ƒë·ªÉ xem</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Column Search Row -->
                <div class="column-search-container" id="dataColumnSearch" style="display: none;">
                    <div class="column-search-grid">
                        <div class="column-search-item">
                            <label>D·ªØ li·ªáu:</label>
                            <div class="search-container">
                                <input type="text" class="column-search-input" data-column="0" placeholder="T√¨m theo d·ªØ li·ªáu..." autocomplete="off">
                                <button class="search-clear-btn" onclick="this.previousElementSibling.value=''; this.closest('.column-search-container').dispatchEvent(new Event('search'));">√ó</button>
                            </div>
                        </div>
                        <div class="column-search-item">
                            <label>Th√™m b·ªüi:</label>
                            <div class="search-container">
                                <input type="text" class="column-search-input" data-column="1" placeholder="T√¨m theo ng∆∞·ªùi th√™m..." autocomplete="off">
                                <button class="search-clear-btn" onclick="this.previousElementSibling.value=''; this.closest('.column-search-container').dispatchEvent(new Event('search'));">√ó</button>
                            </div>
                        </div>
                        <div class="column-search-item">
                            <label>Ng√†y th√™m:</label>
                            <div class="search-container">
                                <input type="text" class="column-search-input" data-column="2" placeholder="T√¨m theo ng√†y..." autocomplete="off">
                                <button class="search-clear-btn" onclick="this.previousElementSibling.value=''; this.closest('.column-search-container').dispatchEvent(new Event('search'));">√ó</button>
                            </div>
                        </div>
                        <div class="column-search-actions">
                            <button class="btn btn-secondary btn-sm" onclick="adminPanel.clearAllColumnSearch('dataColumnSearch')">X√≥a t·∫•t c·∫£</button>
                            <button class="btn btn-secondary btn-sm" onclick="adminPanel.hideColumnSearch('dataColumnSearch')">·∫®n</button>
                        </div>
                    </div>
                </div>
                
                <div id="dataTableContainer">
                    <!-- Data table will be generated here -->
                </div>
            </div>
        </div>

        <!-- User Data Review Tab -->
        <div class="tab-content" id="tab-userdata">
            <div class="dashboard-container">
                <div class="card-header">
                    <h2 class="card-title">Ki·ªÉm tra D·ªØ li·ªáu User Chi ti·∫øt</h2>
                    <div class="btn-group">
                        <div class="custom-select" id="userDataUserSelectContainer">
                            <div class="select-trigger" id="userDataUserSelectTrigger">
                                <span>T·∫•t c·∫£ ng∆∞·ªùi d√πng</span>
                                <span class="arrow">‚ñº</span>
                            </div>
                            <ul class="select-options" id="userDataUserSelectOptions">
                                <li data-value="">T·∫•t c·∫£ ng∆∞·ªùi d√πng</li>
                            </ul>
                        </div>
                        <div class="custom-select" id="userDataFieldSelectContainer">
                            <div class="select-trigger" id="userDataFieldSelectTrigger">
                                <span>T·∫•t c·∫£ tr∆∞·ªùng</span>
                                <span class="arrow">‚ñº</span>
                            </div>
                            <ul class="select-options" id="userDataFieldSelectOptions">
                                <li data-value="">T·∫•t c·∫£ tr∆∞·ªùng</li>
                            </ul>
                        </div>
                        <button class="btn btn-success" id="exportUserDataBtn">üìä Xu·∫•t Excel</button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-3">
                        <div class="stat-card">
                            <div class="stat-number" id="userDataTotal">0</div>
                            <div class="stat-label">T·ªïng d·ªØ li·ªáu</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-card">
                            <div class="stat-number" id="userDataToday">0</div>
                            <div class="stat-label">H√¥m nay</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-card">
                            <div class="stat-number" id="userDataUsers">0</div>
                            <div class="stat-label">Ng∆∞·ªùi ƒë√≥ng g√≥p</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-card">
                            <div class="stat-number" id="userDataContributors">0</div>
                            <div class="stat-label">T·ªïng ng∆∞·ªùi ƒë√≥ng g√≥p</div>
                        </div>
                    </div>
                </div>
                
                <div id="userDataTableContainer">
                    <!-- User data table will be generated here -->
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div class="tab-content" id="tab-export">
            <div class="dashboard-container">
                <div class="card-header">
                    <h2 class="card-title">Xu·∫•t D·ªØ li·ªáu</h2>
                </div>
                
                <div class="row">
                    <div class="col-2">
                        <div class="card">
                            <h3>Xu·∫•t t·∫•t c·∫£ d·ªØ li·ªáu</h3>
                            <p>Xu·∫•t to√†n b·ªô d·ªØ li·ªáu t·ª´ t·∫•t c·∫£ c√°c tr∆∞·ªùng</p>
                            <button class="btn btn-success btn-full" id="exportAllBtn">üìä Xu·∫•t Excel</button>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="card">
                            <h3>Xu·∫•t theo tr∆∞·ªùng</h3>
                            <div class="form-group">
                                <div class="custom-select" id="exportFieldSelectContainer">
                                    <div class="select-trigger" id="exportFieldSelectTrigger">
                                        <span>Ch·ªçn tr∆∞·ªùng</span>
                                        <span class="arrow">‚ñº</span>
                                    </div>
                                    <ul class="select-options" id="exportFieldSelectOptions">
                                        <li data-value="">Ch·ªçn tr∆∞·ªùng</li>
                                    </ul>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-full" id="exportFieldBtn">üìã Xu·∫•t tr∆∞·ªùng</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Scripts -->
    <script src="js/utils.js"></script>
    
    <!-- Global functions that need to be accessible from HTML -->
    <script>
        // Global password toggle function - must be in global scope for onclick
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const hideIcon = button.querySelector('.hide-icon');
            const showIcon = button.querySelector('.show-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                hideIcon.style.display = 'none';
                showIcon.style.display = 'block';
            } else {
                input.type = 'password';
                hideIcon.style.display = 'block';
                showIcon.style.display = 'none';
            }
        }

        // Auto-save functionality for admin forms
        let adminAutoSaveInterval = null;
        
        function startAdminAutoSave() {
            adminAutoSaveInterval = setInterval(() => {
                saveAdminFormDataToLocal();
            }, 10000); // 10 seconds
        }
        
        function stopAdminAutoSave() {
            if (adminAutoSaveInterval) {
                clearInterval(adminAutoSaveInterval);
                adminAutoSaveInterval = null;
            }
        }
        
        function saveAdminFormDataToLocal() {
            try {
                const formData = {
                    timestamp: new Date().toISOString(),
                    page: 'admin',
                    currentTab: window.adminPanel?.currentTab || 'users'
                };
                
                // Save any open modal form data
                const activeModal = document.querySelector('.modal[style*="flex"]');
                if (activeModal) {
                    const form = activeModal.querySelector('form');
                    if (form) {
                        const inputs = form.querySelectorAll('input[type="text"], input[type="email"], textarea');
                        inputs.forEach(input => {
                            if (input.id && input.value) {
                                formData[input.id] = input.value;
                            }
                        });
                    }
                }
                
                localStorage.setItem('admin_form_backup', JSON.stringify(formData));
                console.log('Auto-saved admin form data');
            } catch (error) {
                console.warn('Failed to save admin form data:', error);
            }
        }
        
        function clearAllAdminLocalData() {
            try {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('admin_') || key.startsWith('app_') || key.startsWith('auth_') || key.startsWith('user_'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                console.log('Cleared admin local data:', keysToRemove);
            } catch (error) {
                console.warn('Failed to clear admin local data:', error);
            }
        }
    </script>
    
    <script type="module">
        // Import modules
        import { configManager, rateLimiter } from './js/config.js';
        import { authSystem } from './js/auth.js';

        // Make them globally available
        window.configManager = configManager;
        window.rateLimiter = rateLimiter;
        window.authSystem = authSystem;

        class AdminPanel {
            constructor() {
                this.currentTab = 'users';
                this.customSelects = new Map();
                this.searchTimers = new Map();
                this.columnSearchStates = new Map();
                this.allUsers = [];
                this.allFields = [];
                this.allData = [];
                this.init();
            }

            async init() {
                // Wait for auth system to be ready
                await this.waitForAuth();
                
                // Check authentication
                if (!authSystem.requireAdmin()) {
                    return;
                }

                this.setupEventListeners();
                await this.loadData();
                this.updateUI();
                this.initCustomSelects();
                
                // Start auto-save for admin forms
                startAdminAutoSave();
                
                // Cleanup on page unload
                window.addEventListener('beforeunload', () => {
                    stopAdminAutoSave();
                });
            }

            async waitForAuth() {
                // Wait for Firebase and auth system to be ready
                let attempts = 0;
                while ((!window.authSystem || !authSystem.isLoggedIn()) && attempts < 100) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                    attempts++;
                }
            }

            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // User management
                document.getElementById('addUserBtn').addEventListener('click', () => {
                    this.showAddUserModal();
                });

                // Field management
                document.getElementById('addFieldBtn').addEventListener('click', () => {
                    this.showAddFieldModal();
                });

                // Export functions
                document.getElementById('exportAllBtn').addEventListener('click', () => {
                    this.exportAllDataExcel();
                });

                document.getElementById('exportFieldBtn').addEventListener('click', () => {
                    this.exportFieldDataExcel();
                });

                document.getElementById('exportUserDataBtn').addEventListener('click', () => {
                    this.exportUserDataExcel();
                });

                // Logout
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    // Stop auto-save and clear local data before logout
                    stopAdminAutoSave();
                    clearAllAdminLocalData();
                    
                    authSystem.logout();
                });

                // Enhanced search setup
                this.setupEnhancedSearch();
            }

            setupEnhancedSearch() {
                // Setup clear buttons and enhanced search for each tab
                this.setupTabSearch('users', 'userSearchBox', 'userSearchClear', 'userColumnSearch');
                this.setupTabSearch('fields', 'fieldSearchBox', 'fieldSearchClear', 'fieldColumnSearch');
                this.setupTabSearch('data', 'dataSearchBox', 'dataSearchClear', 'dataColumnSearch');
            }

            setupTabSearch(tabName, searchBoxId, clearBtnId, columnSearchId) {
                const searchBox = document.getElementById(searchBoxId);
                const clearBtn = document.getElementById(clearBtnId);
                const columnSearchContainer = document.getElementById(columnSearchId);

                // Clear button functionality
                clearBtn.addEventListener('click', () => {
                    searchBox.value = '';
                    this.clearSearch(tabName);
                    this.updateSearchUI(searchBox, '');
                });

                // Search input with enhanced features
                searchBox.addEventListener('input', (e) => {
                    const value = e.target.value;
                    this.handleSearch(tabName, value);
                    this.updateSearchUI(searchBox, value);
                });

                // Column search setup
                if (columnSearchContainer) {
                    this.setupColumnSearch(tabName, columnSearchContainer);
                }
            }

            updateSearchUI(searchInput, value) {
                const clearBtn = searchInput.parentElement.querySelector('.search-clear-btn');
                
                if (value.trim()) {
                    clearBtn.style.opacity = '1';
                    clearBtn.style.pointerEvents = 'auto';
                } else {
                    clearBtn.style.opacity = '0.3';
                    clearBtn.style.pointerEvents = 'none';
                }
            }

            setupColumnSearch(tabName, container) {
                const inputs = container.querySelectorAll('.column-search-input');
                
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        this.handleColumnSearch(tabName, container);
                    });
                });

                // Listen for search event from clear buttons
                container.addEventListener('search', () => {
                    this.handleColumnSearch(tabName, container);
                });
            }

            handleColumnSearch(tabName, container) {
                const inputs = container.querySelectorAll('.column-search-input');
                const searchCriteria = {};
                
                inputs.forEach(input => {
                    const columnIndex = parseInt(input.dataset.column);
                    const value = input.value.trim();
                    if (value) {
                        searchCriteria[columnIndex] = value.toLowerCase();
                    }
                });

                this.performColumnSearch(tabName, searchCriteria);
            }

            performColumnSearch(tabName, criteria) {
                const tables = document.querySelectorAll(`#${tabName}TableContainer table`);
                
                tables.forEach(table => {
                    const rows = table.querySelectorAll('tbody tr');
                    let visibleCount = 0;
                    
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        let matches = true;
                        
                        // Check each search criteria
                        for (const [columnIndex, searchValue] of Object.entries(criteria)) {
                            const colIndex = parseInt(columnIndex);
                            if (colIndex >= 0 && colIndex < cells.length) {
                                const cellText = cells[colIndex].textContent.toLowerCase();
                                if (!cellText.includes(searchValue)) {
                                    matches = false;
                                    break;
                                }
                            }
                        }
                        
                        if (matches) {
                            row.style.display = '';
                            row.classList.add('search-highlight');
                            visibleCount++;
                            setTimeout(() => row.classList.remove('search-highlight'), 1000);
                        } else {
                            row.style.display = 'none';
                        }
                    });
                    
                    // Update table info if exists
                    this.updateTableInfo(table, visibleCount, rows.length);
                });
            }

            getColumnIndex(table, columnKey) {
                // This function is no longer needed since we use direct column indexes
                // But keeping it for compatibility
                const columnMap = {
                    'name': 0,
                    'email': 1,
                    'assignedFields': 2,
                    'createdAt': 3,
                    'createdBy': 4,
                    'description': 1,
                    'value': 0,
                    'addedByUsername': 1,
                    'addedAt': 2
                };
                
                return columnMap[columnKey] || -1;
            }

            updateTableInfo(table, visibleCount, totalCount) {
                let infoElement = table.parentElement.querySelector('.table-search-info');
                if (!infoElement) {
                    infoElement = document.createElement('div');
                    infoElement.className = 'table-search-info';
                    infoElement.style.cssText = `
                        text-align: center;
                        padding: 8px;
                        background: rgba(255, 179, 128, 0.1);
                        border-radius: 6px;
                        margin: 10px 0;
                        font-size: 14px;
                        color: #666;
                    `;
                    table.parentElement.insertBefore(infoElement, table);
                }
                
                if (visibleCount < totalCount) {
                    infoElement.textContent = `Hi·ªÉn th·ªã ${visibleCount} trong ${totalCount} m·ª•c`;
                    infoElement.style.display = 'block';
                } else {
                    infoElement.style.display = 'none';
                }
            }

            clearAllColumnSearch(containerId) {
                const container = document.getElementById(containerId);
                const inputs = container.querySelectorAll('.column-search-input');
                
                inputs.forEach(input => {
                    input.value = '';
                });
                
                // Clear the search
                const tabName = containerId.replace('ColumnSearch', '').replace('user', 'users');
                this.performColumnSearch(tabName, {});
            }

            hideColumnSearch(containerId) {
                const container = document.getElementById(containerId);
                container.style.display = 'none';
                
                // Also clear any active search
                this.clearAllColumnSearch(containerId);
            }

            showColumnSearch(containerId) {
                const container = document.getElementById(containerId);
                container.style.display = 'block';
            }

            handleSearch(type, searchTerm) {
                // Clear previous timer
                if (this.searchTimers.has(type)) {
                    clearTimeout(this.searchTimers.get(type));
                }

                // Set new timer for debounced search
                const timer = setTimeout(() => {
                    this.performSearch(type, searchTerm);
                }, 300);

                this.searchTimers.set(type, timer);
            }

            performSearch(type, searchTerm) {
                const tables = document.querySelectorAll(`#${type}TableContainer table`);
                tables.forEach(table => {
                    const rows = table.querySelectorAll('tbody tr');
                    let visibleCount = 0;
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        const matches = searchTerm.toLowerCase().split(' ').every(term => 
                            text.includes(term)
                        );
                        
                        if (matches) {
                            row.style.display = '';
                            visibleCount++;
                        } else {
                            row.style.display = 'none';
                        }
                    });
                    
                    this.updateTableInfo(table, visibleCount, rows.length);
                });
            }

            clearSearch(type) {
                const tables = document.querySelectorAll(`#${type}TableContainer table`);
                tables.forEach(table => {
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        row.style.display = '';
                    });
                    
                    // Hide table info
                    const infoElement = table.parentElement.querySelector('.table-search-info');
                    if (infoElement) {
                        infoElement.style.display = 'none';
                    }
                });
            }

            // Reset search when switching tabs
            resetTabSearch(previousTab) {
                if (previousTab) {
                    // Clear general search
                    const searchBoxId = previousTab === 'users' ? 'userSearchBox' : 
                                       previousTab === 'fields' ? 'fieldSearchBox' : 
                                       previousTab === 'data' ? 'dataSearchBox' : null;
                    
                    if (searchBoxId) {
                        const searchBox = document.getElementById(searchBoxId);
                        if (searchBox) {
                            searchBox.value = '';
                            this.updateSearchUI(searchBox, '');
                        }
                        this.clearSearch(previousTab);
                    }
                    
                    // Clear column search
                    const columnSearchId = previousTab === 'users' ? 'userColumnSearch' : 
                                         previousTab === 'fields' ? 'fieldColumnSearch' : 
                                         previousTab === 'data' ? 'dataColumnSearch' : null;
                    
                    if (columnSearchId) {
                        this.hideColumnSearch(columnSearchId);
                    }
                }
            }

            initCustomSelects() {
                // Initialize all custom selects
                this.initCustomSelect('fieldSelectContainer', 'fieldSelectTrigger', 'fieldSelectOptions', (value) => {
                    this.loadFieldData(value);
                });

                this.initCustomSelect('userDataUserSelectContainer', 'userDataUserSelectTrigger', 'userDataUserSelectOptions', () => {
                    this.loadUserData();
                });

                this.initCustomSelect('userDataFieldSelectContainer', 'userDataFieldSelectTrigger', 'userDataFieldSelectOptions', () => {
                    this.loadUserData();
                });

                this.initCustomSelect('exportFieldSelectContainer', 'exportFieldSelectTrigger', 'exportFieldSelectOptions');
            }

            initCustomSelect(containerId, triggerId, optionsId, onChange = null) {
                const container = document.getElementById(containerId);
                const trigger = document.getElementById(triggerId);
                const options = document.getElementById(optionsId);

                if (!container || !trigger || !options) return;

                // Store reference
                const selectData = {
                    container,
                    trigger,
                    options,
                    value: '',
                    onChange
                };

                this.customSelects.set(containerId, selectData);

                // Click trigger to show/hide options
                trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleCustomSelect(containerId);
                });

                // Click option to select
                options.addEventListener('click', (e) => {
                    const li = e.target.closest('li');
                    if (!li) return;

                    const value = li.dataset.value;
                    const text = li.textContent;

                    this.setCustomSelectValue(containerId, value, text);
                    this.hideCustomSelect(containerId);

                    if (onChange) {
                        onChange(value);
                    }
                });

                // Close when clicking outside
                document.addEventListener('click', (e) => {
                    if (!container.contains(e.target)) {
                        this.hideCustomSelect(containerId);
                    }
                });
            }

            toggleCustomSelect(containerId) {
                const selectData = this.customSelects.get(containerId);
                if (!selectData) return;

                const isActive = selectData.options.classList.contains('active');
                
                // Close all other selects
                this.customSelects.forEach((data, id) => {
                    if (id !== containerId) {
                        this.hideCustomSelect(id);
                    }
                });

                if (isActive) {
                    this.hideCustomSelect(containerId);
                } else {
                    this.showCustomSelect(containerId);
                }
            }

            showCustomSelect(containerId) {
                const selectData = this.customSelects.get(containerId);
                if (!selectData) return;

                selectData.trigger.classList.add('active');
                selectData.options.classList.add('active');
            }

            hideCustomSelect(containerId) {
                const selectData = this.customSelects.get(containerId);
                if (!selectData) return;

                selectData.trigger.classList.remove('active');
                selectData.options.classList.remove('active');
            }

            setCustomSelectValue(containerId, value, text) {
                const selectData = this.customSelects.get(containerId);
                if (!selectData) return;

                selectData.value = value;
                selectData.trigger.querySelector('span').textContent = text;

                // Update selected option
                selectData.options.querySelectorAll('li').forEach(li => {
                    li.classList.remove('selected');
                    if (li.dataset.value === value) {
                        li.classList.add('selected');
                    }
                });
            }

            getCustomSelectValue(containerId) {
                const selectData = this.customSelects.get(containerId);
                return selectData ? selectData.value : '';
            }

            populateCustomSelect(containerId, options) {
                const selectData = this.customSelects.get(containerId);
                if (!selectData) return;

                const optionsHtml = options.map(option => 
                    `<li data-value="${option.value}">${option.text}</li>`
                ).join('');

                selectData.options.innerHTML = optionsHtml;
            }

            switchTab(tabName) {
                // Reset search for previous tab
                this.resetTabSearch(this.currentTab);
                
                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update active tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`tab-${tabName}`).classList.add('active');

                this.currentTab = tabName;

                // Load specific data for tab
                if (tabName === 'data') {
                    this.loadFieldOptions();
                } else if (tabName === 'export') {
                    this.loadExportOptions();
                } else if (tabName === 'userdata') {
                    this.loadUserDataOptions();
                }
            }

            async loadData() {
                await this.loadStatistics();
                await this.loadUsers();
                await this.loadFields();
            }

            async loadStatistics() {
                const users = await authSystem.getUsers();
                const fields = await authSystem.getFields();
                let totalData = 0;
                let totalDuplicates = 0;

                fields.forEach(field => {
                    totalData += (field.data || []).length;
                    // Check for duplicates within field
                    const values = (field.data || []).map(item => item.value);
                    const duplicates = values.filter((value, index) => values.indexOf(value) !== index);
                    totalDuplicates += duplicates.length;
                });

                // Animate numbers
                Utils.animateNumber(document.getElementById('totalUsers'), 0, users.length);
                Utils.animateNumber(document.getElementById('totalFields'), 0, fields.length);
                Utils.animateNumber(document.getElementById('totalData'), 0, totalData);
                Utils.animateNumber(document.getElementById('totalDuplicates'), 0, totalDuplicates);
            }

            async loadUsers() {
                const users = await authSystem.getUsers();
                
                // Sort users by creation date - newest first
                users.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                const container = document.getElementById('usersTableContainer');

                const columns = [
                    { key: 'name', title: 'T√™n', searchable: true },
                    { key: 'email', title: 'Email', searchable: true },
                    { key: 'assignedFields', title: 'Tr∆∞·ªùng ƒë∆∞·ª£c g√°n', render: (fields) => (fields || []).length + ' tr∆∞·ªùng' },
                    { 
                        key: 'status', 
                        title: 'Tr·∫°ng th√°i', 
                        render: (status) => {
                            const isLocked = status === false;
                            return `<span class="status-badge ${isLocked ? 'status-locked' : 'status-active'}">${isLocked ? 'üîí B·ªã kh√≥a' : '‚úÖ Ho·∫°t ƒë·ªông'}</span>`;
                        }
                    },
                    { key: 'createdAt', title: 'Ng√†y t·∫°o', type: 'dateShort', searchable: true },
                    { key: 'createdBy', title: 'T·∫°o b·ªüi', searchable: true }
                ];

                const options = {
                    actions: (user) => {
                        const isLocked = user.status === false;
                        const lockBtnClass = isLocked ? 'btn-success' : 'btn-warning';
                        const lockBtnText = isLocked ? 'üîì M·ªü kh√≥a' : 'üîí Kh√≥a';
                        return `
                            <button class="btn btn-secondary" onclick="adminPanel.editUser('${user.id}')" style="margin-right: 5px; padding: 5px 10px;">‚úèÔ∏è</button>
                            <button class="btn ${lockBtnClass}" onclick="adminPanel.toggleUserLock('${user.id}')" style="padding: 5px 10px;">${lockBtnText}</button>
                        `;
                    },
                    onHeaderClick: (column, index) => {
                        if (column.searchable) {
                            this.showColumnSearch('userColumnSearch');
                        }
                    }
                };

                const table = Utils.createTable(users, columns, options);
                container.innerHTML = '';
                container.appendChild(table);
                
                // Add click handlers to searchable headers
                this.addHeaderClickHandlers(table, 'userColumnSearch');
            }

            async loadFields() {
                const fields = await authSystem.getAllFieldsForAdmin();
                
                // Sort fields by creation date - newest first
                fields.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                const users = await authSystem.getUsers();
                const container = document.getElementById('fieldsTableContainer');

                const columns = [
                    { key: 'name', title: 'T√™n tr∆∞·ªùng', searchable: true },
                    { key: 'description', title: 'M√¥ t·∫£', searchable: true },
                    { 
                        key: 'data', 
                        title: 'S·ªë l∆∞·ª£ng d·ªØ li·ªáu', 
                        render: (data) => (data || []).length + ' m·ª•c' 
                    },
                    { 
                        key: 'assignedUsers', 
                        title: 'G√°n', 
                        render: (assignedUsers, field) => {
                            const assignedCount = this.getAssignedUserCount(field.id, users);
                            return `<button class="btn btn-secondary" onclick="adminPanel.showFieldAssignmentModal('${field.id}')" style="padding: 5px 10px;">${assignedCount} ng∆∞·ªùi</button>`;
                        }
                    },
                    { key: 'createdAt', title: 'Ng√†y t·∫°o', type: 'dateShort', searchable: true },
                    { key: 'createdBy', title: 'T·∫°o b·ªüi', searchable: true }
                ];

                const options = {
                    actions: (field) => `
                        <button class="btn btn-secondary" onclick="adminPanel.editField('${field.id}')" style="margin-right: 5px; padding: 5px 10px;">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="adminPanel.deleteField('${field.id}')" style="padding: 5px 10px;">üóëÔ∏è</button>
                    `,
                    pagination: true,
                    itemsPerPage: 10,
                    onHeaderClick: (column, index) => {
                        if (column.searchable) {
                            this.showColumnSearch('fieldColumnSearch');
                        }
                    }
                };

                const table = Utils.createTable(fields, columns, options);
                container.innerHTML = '';
                container.appendChild(table);
                
                // Add click handlers to searchable headers
                this.addHeaderClickHandlers(table, 'fieldColumnSearch');
            }

            addHeaderClickHandlers(table, columnSearchId) {
                const headers = table.querySelectorAll('thead th');
                headers.forEach((header, index) => {
                    const headerText = header.textContent.trim().toLowerCase();
                    
                    // Only add click handlers to searchable columns
                    if (headerText.includes('t√™n') || headerText.includes('email') || 
                        headerText.includes('m√¥ t·∫£') || headerText.includes('ng√†y') ||
                        headerText.includes('d·ªØ li·ªáu') || headerText.includes('th√™m b·ªüi') ||
                        headerText.includes('t·∫°o b·ªüi')) {
                        
                        header.classList.add('searchable');
                        header.addEventListener('click', () => {
                            this.showColumnSearch(columnSearchId);
                            
                            // Focus on relevant input based on header content
                            setTimeout(() => {
                                const container = document.getElementById(columnSearchId);
                                const inputs = container.querySelectorAll('.column-search-input');
                                
                                // Map header text to appropriate input
                                let targetInput = null;
                                if (headerText.includes('t√™n')) {
                                    targetInput = inputs[0]; // First input (name)
                                } else if (headerText.includes('email')) {
                                    targetInput = inputs[1]; // Second input (email)
                                } else if (headerText.includes('m√¥ t·∫£')) {
                                    targetInput = inputs[1]; // Description (for fields)
                                } else if (headerText.includes('d·ªØ li·ªáu') || headerText.includes('th√™m b·ªüi')) {
                                    targetInput = inputs[1]; // Data or added by
                                } else if (headerText.includes('ng√†y')) {
                                    // Find the date input (varies by tab)
                                    targetInput = Array.from(inputs).find(input => 
                                        input.placeholder.includes('ng√†y')
                                    );
                                } else if (headerText.includes('t·∫°o b·ªüi')) {
                                    // Find the created by input
                                    targetInput = Array.from(inputs).find(input => 
                                        input.placeholder.includes('ng∆∞·ªùi t·∫°o')
                                    );
                                }
                                
                                if (targetInput) {
                                    targetInput.focus();
                                }
                            }, 100);
                        });
                    }
                });
            }

            getAssignedUserCount(fieldId, users) {
                return users.filter(user => 
                    user.assignedFields && user.assignedFields.includes(fieldId)
                ).length;
            }

            async showFieldAssignmentModal(fieldId) {
                const fields = await authSystem.getAllFieldsForAdmin();
                const users = await authSystem.getUsers();
                const field = fields.find(f => f.id === fieldId);
                
                if (!field) {
                    Utils.showError('Kh√¥ng t√¨m th·∫•y tr∆∞·ªùng!');
                    return;
                }

                let assignedUserIds = users.filter(user => 
                    user.assignedFields && user.assignedFields.includes(fieldId)
                ).map(user => user.id);

                let unassignedUserIds = users.filter(user => 
                    !user.assignedFields || !user.assignedFields.includes(fieldId)
                ).map(user => user.id);

                const modal = Utils.createModal({
                    title: `Qu·∫£n l√Ω g√°n tr∆∞·ªùng: ${field.name}`,
                    content: `
                        <div>
                            <input type="text" id="userSearchInput" class="search-input" placeholder="üîç T√¨m ki·∫øm ng∆∞·ªùi d√πng..." autocomplete="off">
                            
                            <div class="field-assignment-container">
                                <div class="field-assignment-column">
                                    <div class="field-assignment-header">
                                        <h4 style="margin: 0; color: #ff9800;">Ch∆∞a ƒë∆∞·ª£c g√°n (<span id="unassignedCount">${unassignedUserIds.length}</span>)</h4>
                                        <button class="btn btn-success" id="assignAllBtn" style="padding: 6px 12px; font-size: 12px;">
                                            ‚ûï G√°n t·∫•t c·∫£
                                        </button>
                                    </div>
                                    <div id="unassignedUsersList" class="field-assignment-list unassigned">
                                        ${this.renderUserList(users, unassignedUserIds, 'unassigned', fieldId)}
                                    </div>
                                </div>
                                
                                <div class="field-assignment-column">
                                    <div class="field-assignment-header">
                                        <h4 style="margin: 0; color: #4caf50;">ƒê√£ ƒë∆∞·ª£c g√°n (<span id="assignedCount">${assignedUserIds.length}</span>)</h4>
                                        <button class="btn btn-danger" id="removeAllBtn" style="padding: 6px 12px; font-size: 12px;">
                                            ‚ûñ B·ªè g√°n t·∫•t c·∫£
                                        </button>
                                    </div>
                                    <div id="assignedUsersList" class="field-assignment-list assigned">
                                        ${this.renderUserList(users, assignedUserIds, 'assigned', fieldId)}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal-actions">
                                <button class="btn btn-secondary" id="closeModalBtn">ƒê√≥ng</button>
                                <button class="btn btn-primary" id="saveAssignmentsBtn">üíæ L∆∞u thay ƒë·ªïi</button>
                            </div>
                        </div>
                    `,
                    size: 'large',
                    closable: true
                });

                // Store current state
                modal.fieldId = fieldId;
                modal.assignedUserIds = new Set(assignedUserIds);
                modal.unassignedUserIds = new Set(unassignedUserIds);
                modal.users = users;

                // Add search functionality
                document.getElementById('userSearchInput').addEventListener('input', (e) => {
                    this.filterUsersInModal(e.target.value, modal);
                });

                // Assign all button
                document.getElementById('assignAllBtn').addEventListener('click', () => {
                    this.assignAllUsers(modal);
                });

                // Remove all button  
                document.getElementById('removeAllBtn').addEventListener('click', () => {
                    this.removeAllUsers(modal);
                });

                // Close button
                document.getElementById('closeModalBtn').addEventListener('click', () => {
                    modal.style.display = 'none';
                    document.body.removeChild(modal);
                });

                // Save button
                document.getElementById('saveAssignmentsBtn').addEventListener('click', async () => {
                    await this.saveFieldAssignments(modal);
                });

            }

            renderUserList(users, userIds, type, fieldId) {
                return Array.from(userIds).map(userId => {
                    const user = users.find(u => u.id === userId);
                    if (!user) return '';
                    
                    return `
                        <div class="user-item" data-user-id="${user.id}" data-user-name="${user.name}">
                            <span>${user.name} (${user.email})</span>
                            <button class="btn ${type === 'assigned' ? 'btn-danger' : 'btn-success'}" 
                                    onclick="adminPanel.${type === 'assigned' ? 'removeUserFromField' : 'addUserToField'}('${user.id}')" 
                                    style="padding: 2px 8px; margin-left: 10px;">
                                ${type === 'assigned' ? '√ó' : '+'}
                            </button>
                        </div>
                    `;
                }).join('');
            }

            addUserToField(userId) {
                const modal = document.querySelector('.modal[style*="flex"]');
                if (!modal) return;

                // Move user from unassigned to assigned
                modal.unassignedUserIds.delete(userId);
                modal.assignedUserIds.add(userId);

                // Update the UI
                this.updateModalUserLists(modal);
            }

            removeUserFromField(userId) {
                const modal = document.querySelector('.modal[style*="flex"]');
                if (!modal) return;

                // Move user from assigned to unassigned
                modal.assignedUserIds.delete(userId);
                modal.unassignedUserIds.add(userId);

                // Update the UI
                this.updateModalUserLists(modal);
            }

            assignAllUsers(modal) {
                // Move all unassigned users to assigned
                modal.unassignedUserIds.forEach(userId => {
                    modal.assignedUserIds.add(userId);
                });
                modal.unassignedUserIds.clear();

                this.updateModalUserLists(modal);
            }

            removeAllUsers(modal) {
                // Move all assigned users to unassigned
                modal.assignedUserIds.forEach(userId => {
                    modal.unassignedUserIds.add(userId);
                });
                modal.assignedUserIds.clear();

                this.updateModalUserLists(modal);
            }

            updateModalUserLists(modal) {
                const unassignedContainer = document.getElementById('unassignedUsersList');
                const assignedContainer = document.getElementById('assignedUsersList');
                const unassignedCount = document.getElementById('unassignedCount');
                const assignedCount = document.getElementById('assignedCount');

                unassignedContainer.innerHTML = this.renderUserList(modal.users, modal.unassignedUserIds, 'unassigned', modal.fieldId);
                assignedContainer.innerHTML = this.renderUserList(modal.users, modal.assignedUserIds, 'assigned', modal.fieldId);
                
                unassignedCount.textContent = modal.unassignedUserIds.size;
                assignedCount.textContent = modal.assignedUserIds.size;
            }

            filterUsersInModal(searchTerm, modal) {
                const userItems = document.querySelectorAll('.user-item');
                userItems.forEach(item => {
                    const userName = item.dataset.userName.toLowerCase();
                    const userEmail = item.querySelector('span').textContent.toLowerCase();
                    if (userName.includes(searchTerm.toLowerCase()) || userEmail.includes(searchTerm.toLowerCase())) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }

            async saveFieldAssignments(modal) {
                try {
                    Utils.showInfo('ƒêang l∆∞u thay ƒë·ªïi...');

                    // Update each user's assigned fields
                    const updatePromises = modal.users.map(async (user) => {
                        const currentFields = user.assignedFields || [];
                        let newFields = [...currentFields];

                        if (modal.assignedUserIds.has(user.id)) {
                            // User should have this field assigned
                            if (!newFields.includes(modal.fieldId)) {
                                newFields.push(modal.fieldId);
                            }
                        } else {
                            // User should not have this field assigned
                            newFields = newFields.filter(fieldId => fieldId !== modal.fieldId);
                        }

                        // Only update if there's a change
                        if (JSON.stringify(currentFields.sort()) !== JSON.stringify(newFields.sort())) {
                            return authSystem.updateUser(user.id, {
                                assignedFields: newFields
                            });
                        }
                        return { success: true };
                    });

                    const results = await Promise.all(updatePromises);
                    const failures = results.filter(result => !result.success);

                    if (failures.length === 0) {
                        Utils.showSuccess('L∆∞u g√°n tr∆∞·ªùng th√†nh c√¥ng!');
                        
                        // Close modal
                        modal.style.display = 'none';
                        document.body.removeChild(modal);
                        
                        // Refresh the fields table and users table
                        await Promise.all([
                            this.loadFields(),
                            this.loadUsers()
                        ]);
                    } else {
                        Utils.showError(`C√≥ ${failures.length} l·ªói khi c·∫≠p nh·∫≠t. Vui l√≤ng th·ª≠ l·∫°i!`);
                    }
                } catch (error) {
                    console.error('Save field assignments error:', error);
                    Utils.showError('C√≥ l·ªói x·∫£y ra khi l∆∞u g√°n tr∆∞·ªùng!');
                }
            }

            async loadFieldOptions() {
                const fields = await authSystem.getAllFieldsForAdmin();
                
                const fieldOptions = [
                    { value: '', text: 'Ch·ªçn tr∆∞·ªùng ƒë·ªÉ xem' },
                    ...fields.map(field => ({ value: field.id, text: field.name }))
                ];

                const exportFieldOptions = [
                    { value: '', text: 'Ch·ªçn tr∆∞·ªùng' },
                    ...fields.map(field => ({ value: field.id, text: field.name }))
                ];

                this.populateCustomSelect('fieldSelectContainer', fieldOptions);
                this.populateCustomSelect('exportFieldSelectContainer', exportFieldOptions);
            }

            async loadExportOptions() {
                await this.loadFieldOptions();
            }

            async loadFieldData(fieldId) {
                if (!fieldId) {
                    document.getElementById('dataTableContainer').innerHTML = '';
                    return;
                }

                const fields = await authSystem.getAllFieldsForAdmin();
                const users = await authSystem.getUsers();
                const field = fields.find(f => f.id === fieldId);
                
                if (!field) return;

                const container = document.getElementById('dataTableContainer');
                
                // Map data with usernames
                const dataWithUsernames = (field.data || []).map(item => {
                    const user = users.find(u => u.email === item.addedBy);
                    return {
                        ...item,
                        addedByUsername: user ? user.username || user.name : item.addedBy
                    };
                }).sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt));
                
                const columns = [
                    { key: 'value', title: 'D·ªØ li·ªáu', searchable: true },
                    { key: 'addedByUsername', title: 'Th√™m b·ªüi', searchable: true },
                    { key: 'addedAt', title: 'Ng√†y th√™m', type: 'date', searchable: true }
                ];

                const options = {
                    actions: (data) => `
                        <button class="btn btn-danger" onclick="adminPanel.deleteData('${fieldId}', '${data.id}')" style="padding: 5px 10px;">üóëÔ∏è</button>
                    `,
                    pagination: true,
                    itemsPerPage: 10,
                    onHeaderClick: (column, index) => {
                        if (column.searchable) {
                            this.showColumnSearch('dataColumnSearch');
                        }
                    }
                };

                const table = Utils.createTable(dataWithUsernames, columns, options);
                container.innerHTML = `<h3>D·ªØ li·ªáu trong tr∆∞·ªùng: ${field.name}</h3>`;
                container.appendChild(table);
                
                // Add click handlers to searchable headers
                this.addHeaderClickHandlers(table, 'dataColumnSearch');
            }

            showAddUserModal() {
                const modal = Utils.createModal({
                    title: 'Th√™m Ng∆∞·ªùi D√πng M·ªõi',
                    content: `
                        <form id="createUserForm" autocomplete="off">
                            <div class="form-group">
                                <label for="userUsername">T√™n ƒëƒÉng nh·∫≠p</label>
                                <input type="text" id="userUsername" name="new-username" class="form-input" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p"  autocomplete="new-password" data-lpignore="true" data-form-type="other">
                                <div class="field-error" id="usernameError"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="userEmail">Email (t√πy ch·ªçn)</label>
                                <input type="text" id="userEmail" name="new-email" class="form-input" placeholder="Nh·∫≠p email ho·∫∑c ƒë·ªÉ tr·ªëng" autocomplete="new-password" data-lpignore="true" data-form-type="other">
                                <div class="field-error" id="emailError"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="userPassword">M·∫≠t kh·∫©u (ƒë·ªÉ tr·ªëng s·∫Ω d√πng 123456)</label>
                                <div class="password-input-container">
                                    <input type="password" id="userPassword" name="new-password" class="form-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u ho·∫∑c ƒë·ªÉ tr·ªëng" autocomplete="new-password" data-lpignore="true" data-form-type="other">
                                    <button type="button" class="password-toggle" onclick="togglePassword('userPassword', this)">
                                        <svg class="password-icon hide-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M4 4L9.87868 9.87868M20 20L14.1213 14.1213M9.87868 9.87868C9.33579 10.4216 9 11.1716 9 12C9 13.6569 10.3431 15 12 15C12.8284 15 13.5784 14.6642 14.1213 14.1213M9.87868 9.87868L14.1213 14.1213M6.76821 6.76821C4.72843 8.09899 2.96378 10.026 2 11.9998C3.74646 15.5764 8.12201 19 11.9998 19C13.7376 19 15.5753 18.3124 17.2317 17.2317M9.76138 5.34717C10.5114 5.12316 11.2649 5 12.0005 5C15.8782 5 20.2531 8.42398 22 12.0002C21.448 13.1302 20.6336 14.2449 19.6554 15.2412" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <svg class="password-icon show-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                                            <path fill-rule="evenodd" d="M12,4 C14.7275481,4 17.3356792,5.4306247 19.76629,7.78114976 C20.5955095,8.58304746 21.3456935,9.43915664 22.0060909,10.2956239 C22.4045936,10.8124408 22.687526,11.2189945 22.8424353,11.4612025 L23.1870348,12 L22.8424353,12.5387975 C22.687526,12.7810055 22.4045936,13.1875592 22.0060909,13.7043761 C21.3456935,14.5608434 20.5955095,15.4169525 19.76629,16.2188502 C17.3356792,18.5693753 14.7275481,20 12,20 C9.27245185,20 6.66432084,18.5693753 4.23371003,16.2188502 C3.40449054,15.4169525 2.65430652,14.5608434 1.99390911,13.7043761 C1.59540638,13.1875592 1.31247398,12.7810055 1.15756471,12.5387975 L0.812965202,12 L1.15756471,11.4612025 C1.31247398,11.2189945 1.59540638,10.8124408 1.99390911,10.2956239 C2.65430652,9.43915664 3.40449054,8.58304746 4.23371003,7.78114976 C6.66432084,5.4306247 9.27245185,4 12,4 Z M20.4222529,11.5168761 C19.8176112,10.7327184 19.1301624,9.94820254 18.37596,9.21885024 C16.2825083,7.1943753 14.1050769,6 12,6 C9.89492315,6 7.71749166,7.1943753 5.62403997,9.21885024 C4.86983759,9.94820254 4.18238879,10.7327184 3.57774714,11.5168761 C3.44715924,11.6862352 3.32648802,11.8478224 3.21616526,12 C3.32648802,12.1521776 3.44715924,12.3137648 3.57774714,12.4831239 C4.18238879,13.2672816 4.86983759,14.0517975 5.62403997,14.7811498 C7.71749166,16.8056247 9.89492315,18 12,18 C14.1050769,18 16.2825083,16.8056247 18.37596,14.7811498 C19.1301624,14.0517975 19.8176112,13.2672816 20.4222529,12.4831239 C20.5528408,12.3137648 20.673512,12.1521776 20.7838347,12 C20.673512,11.8478224 20.5528408,11.6862352 20.4222529,11.5168761 Z M12,16 C9.790861,16 8,14.209139 8,12 C8,9.790861 9.790861,8 12,8 C14.209139,8 16,9.790861 16,12 C16,14.209139 14.209139,16 12,16 Z M12,14 C13.1045695,14 14,13.1045695 14,12 C14,10.8954305 13.1045695,10 12,10 C10.8954305,10 10,10.8954305 10,12 C10,13.1045695 10.8954305,14 12,14 Z" fill="currentColor"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="field-error" id="passwordError"></div>
                            </div>
                            
                            <div class="btn-group">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').style.display='none'; document.body.removeChild(this.closest('.modal'));">H·ªßy</button>
                                <button type="submit" id="createUserBtn" class="btn btn-primary">üë§ T·∫°o Ng∆∞·ªùi d√πng</button>
                            </div>
                        </form>
                    `,
                    closable: true
                });


                // Add form submission handler
                document.getElementById('createUserForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleAddUser(modal);
                });
            }

            async handleAddUser(modal) {
                // Clear previous errors
                this.clearFieldErrors();

                const username = document.getElementById('userUsername').value.trim();
                const email = document.getElementById('userEmail').value.trim() || null;
                const password = document.getElementById('userPassword').value.trim() || '123456';

                let hasErrors = false;

                // Validate username
                if (!username) {
                    this.showFieldError('usernameError', 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p!');
                    hasErrors = true;
                } else if (username.length < 3) {
                    this.showFieldError('usernameError', 'T√™n ƒëƒÉng nh·∫≠p ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±!');
                    hasErrors = true;
                }

                // Validate password if provided
                if (password && password.length < 6 && password !== '123456') {
                    this.showFieldError('passwordError', 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
                    hasErrors = true;
                }

                if (hasErrors) return;

                // Add loading state to button
                const createBtn = document.getElementById('createUserBtn');
                const originalText = createBtn.innerHTML;
                createBtn.innerHTML = '‚è≥ ƒêang t·∫°o...';
                createBtn.disabled = true;

                // Name = username for display
                const name = username;

                try {
                    // Fast user creation
                    const result = await authSystem.createUser({ name, email, username, password });
                    
                    if (result.success) {
                        // Immediate success feedback
                        createBtn.innerHTML = '‚úÖ Th√†nh c√¥ng!';
                        Utils.showSuccess('Th√™m ng∆∞·ªùi d√πng th√†nh c√¥ng!');
                        
                        // Close modal immediately for better UX
                        modal.style.display = 'none';
                        document.body.removeChild(modal);
                        
                        // Optimistic UI update - add user to table immediately
                        this.addUserToTableOptimistic({
                            id: result.user.id,
                            name: result.user.name,
                            email: result.user.email,
                            assignedFields: result.user.assignedFields || [],
                            createdAt: new Date().toISOString(),
                            createdBy: authSystem.getCurrentUser().email
                        });
                        
                        // Update statistics immediately (optimistic)
                        this.updateStatisticsOptimistic('user', 1);
                        
                        // Background refresh (non-blocking)
                        setTimeout(async () => {
                            try {
                                await Promise.all([
                                    this.loadUsers(),
                                    this.loadStatistics()
                                ]);
                            } catch (error) {
                                console.error('Background refresh error:', error);
                            }
                        }, 100);
                        
                    } else {
                        // Reset button on error
                        createBtn.innerHTML = originalText;
                        createBtn.disabled = false;
                        
                        // Check for specific field errors
                        if (result.message.includes('T√™n ng∆∞·ªùi d√πng ƒë√£ t·ªìn t·∫°i') || result.message.includes('username')) {
                            this.showFieldError('usernameError', result.message);
                        } else if (result.message.includes('Email ƒë√£ t·ªìn t·∫°i') || result.message.includes('email')) {
                            this.showFieldError('emailError', result.message);
                        } else {
                            // System error - show modal
                            this.showSystemErrorModal(result.message);
                        }
                    }
                } catch (error) {
                    // Reset button on error
                    createBtn.innerHTML = originalText;
                    createBtn.disabled = false;
                    
                    console.error('Create user error:', error);
                    this.showSystemErrorModal('C√≥ l·ªói h·ªá th·ªëng x·∫£y ra khi t·∫°o ng∆∞·ªùi d√πng!');
                }
            }

            showFieldError(fieldId, message) {
                const errorElement = document.getElementById(fieldId);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                }
            }

            clearFieldErrors() {
                const errorElements = document.querySelectorAll('.field-error');
                errorElements.forEach(element => {
                    element.textContent = '';
                    element.style.display = 'none';
                });
            }

            showSystemErrorModal(message) {
                const errorModal = Utils.createModal({
                    title: '‚ùå L·ªói H·ªá Th·ªëng',
                    content: `
                        <div style="text-align: center; padding: 20px;">
                            <p style="color: #d32f2f; font-size: 16px; margin-bottom: 20px;">${message}</p>
                            <button class="btn btn-secondary" onclick="this.closest('.modal').style.display='none'; document.body.removeChild(this.closest('.modal'));">ƒê√≥ng</button>
                        </div>
                    `,
                    size: 'small',
                    closable: true,
                    allowOverlayClose: true
                });
            }

            showAddFieldModal() {
                const modal = Utils.createModal({
                    title: 'Th√™m Tr∆∞·ªùng D·ªØ Li·ªáu M·ªõi',
                    content: `
                        <form id="addFieldForm">
                            <div class="form-group">
                                <label>T√™n tr∆∞·ªùng</label>
                                <input type="text" id="fieldName" class="form-input" required autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label>M√¥ t·∫£</label>
                                <textarea id="fieldDescription" class="form-input" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="assignToAll" checked> 
                                    G√°n cho t·∫•t c·∫£ ng∆∞·ªùi d√πng hi·ªán t·∫°i
                                </label>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').style.display='none'; document.body.removeChild(this.closest('.modal'));">H·ªßy</button>
                                <button type="submit" class="btn btn-primary">Th√™m tr∆∞·ªùng</button>
                            </div>
                        </form>
                    `,
                    size: 'medium',
                    closable: true
                });



                // Add form submission handler
                document.getElementById('addFieldForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleAddField(modal);
                });
            }

            async handleAddField(modal) {
                const name = document.getElementById('fieldName').value.trim();
                const description = document.getElementById('fieldDescription').value.trim();
                const assignToAll = document.getElementById('assignToAll').checked;

                if (!name) {
                    Utils.showError('Vui l√≤ng nh·∫≠p t√™n tr∆∞·ªùng!');
                    return;
                }

                // Add loading state to submit button
                const submitBtn = modal.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '‚è≥ ƒêang t·∫°o...';
                submitBtn.disabled = true;

                try {
                    // Fast field creation
                    const result = await authSystem.createField({ name, description });
                    
                    if (result.success) {
                        // Immediate success feedback
                        submitBtn.innerHTML = '‚úÖ Th√†nh c√¥ng!';
                        Utils.showSuccess('Th√™m tr∆∞·ªùng th√†nh c√¥ng!');
                        
                        // Close modal immediately
                        modal.style.display = 'none';
                        document.body.removeChild(modal);
                        
                        // Optimistic UI update
                        this.addFieldToTableOptimistic({
                            id: result.field.id,
                            name: result.field.name,
                            description: result.field.description,
                            data: [],
                            createdAt: new Date().toISOString(),
                            createdBy: authSystem.getCurrentUser().email
                        });
                        
                        // Update statistics immediately
                        this.updateStatisticsOptimistic('field', 1);
                        
                        // Background assignment and refresh
                        setTimeout(async () => {
                            try {
                                // If assign to all is checked, assign this field to all users
                                if (assignToAll) {
                                    await this.assignFieldToAllUsers(result.field.id);
                                }
                                
                                // Background refresh
                                await Promise.all([
                                    this.loadFields(),
                                    this.loadStatistics()
                                ]);
                            } catch (error) {
                                console.error('Background field operations error:', error);
                            }
                        }, 100);
                        
                    } else {
                        // Reset button on error
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        Utils.showError(result.message);
                    }
                } catch (error) {
                    // Reset button on error
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    Utils.showError('C√≥ l·ªói x·∫£y ra khi t·∫°o tr∆∞·ªùng!');
                }
            }

            async assignFieldToAllUsers(fieldId) {
                try {
                    const users = await authSystem.getUsers();
                    
                    for (const user of users) {
                        const currentFields = user.assignedFields || [];
                        if (!currentFields.includes(fieldId)) {
                            const updatedFields = [...currentFields, fieldId];
                            await authSystem.updateUser(user.id, {
                                assignedFields: updatedFields
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error assigning field to all users:', error);
                    Utils.showWarning('Tr∆∞·ªùng ƒë√£ ƒë∆∞·ª£c t·∫°o nh∆∞ng c√≥ l·ªói khi g√°n cho t·∫•t c·∫£ ng∆∞·ªùi d√πng');
                }
            }

            async editUser(userId) {
                // Get user data first
                const users = await authSystem.getUsers();
                const user = users.find(u => u.id === userId);
                
                if (!user) {
                    Utils.showError('Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng!');
                    return;
                }

                const modal = Utils.createModal({
                    title: 'Ch·ªânh s·ª≠a Ng∆∞·ªùi D√πng',
                    content: `
                        <form id="editUserForm">
                            <div class="form-group">
                                <label for="editUserUsername">T√™n ƒëƒÉng nh·∫≠p</label>
                                <input type="text" id="editUserUsername" class="form-input" value="${user.username || user.email}" required autocomplete="off">
                            </div>
                            
                            <div class="form-group">
                                <label for="editUserEmail">Email</label>
                                <input type="text" id="editUserEmail" class="form-input" value="${user.email || ''}" placeholder="Email (t√πy ch·ªçn)" autocomplete="off">
                            </div>
                            
                            <div class="form-group">
                                <label for="editUserPassword">M·∫≠t kh·∫©u m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</label>
                                <div class="password-input-container">
                                    <input type="password" id="editUserPassword" class="form-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" autocomplete="off">
                                    <button type="button" class="password-toggle" onclick="togglePassword('editUserPassword', this)">
                                        <svg class="password-icon hide-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M4 4L9.87868 9.87868M20 20L14.1213 14.1213M9.87868 9.87868C9.33579 10.4216 9 11.1716 9 12C9 13.6569 10.3431 15 12 15C12.8284 15 13.5784 14.6642 14.1213 14.1213M9.87868 9.87868L14.1213 14.1213M6.76821 6.76821C4.72843 8.09899 2.96378 10.026 2 11.9998C3.74646 15.5764 8.12201 19 11.9998 19C13.7376 19 15.5753 18.3124 17.2317 17.2317M9.76138 5.34717C10.5114 5.12316 11.2649 5 12.0005 5C15.8782 5 20.2531 8.42398 22 12.0002C21.448 13.1302 20.6336 14.2449 19.6554 15.2412" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <svg class="password-icon show-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                                            <path fill-rule="evenodd" d="M12,4 C14.7275481,4 17.3356792,5.4306247 19.76629,7.78114976 C20.5955095,8.58304746 21.3456935,9.43915664 22.0060909,10.2956239 C22.4045936,10.8124408 22.687526,11.2189945 22.8424353,11.4612025 L23.1870348,12 L22.8424353,12.5387975 C22.687526,12.7810055 22.4045936,13.1875592 22.0060909,13.7043761 C21.3456935,14.5608434 20.5955095,15.4169525 19.76629,16.2188502 C17.3356792,18.5693753 14.7275481,20 12,20 C9.27245185,20 6.66432084,18.5693753 4.23371003,16.2188502 C3.40449054,15.4169525 2.65430652,14.5608434 1.99390911,13.7043761 C1.59540638,13.1875592 1.31247398,12.7810055 1.15756471,12.5387975 L0.812965202,12 L1.15756471,11.4612025 C1.31247398,11.2189945 1.59540638,10.8124408 1.99390911,10.2956239 C2.65430652,9.43915664 3.40449054,8.58304746 4.23371003,7.78114976 C6.66432084,5.4306247 9.27245185,4 12,4 Z M20.4222529,11.5168761 C19.8176112,10.7327184 19.1301624,9.94820254 18.37596,9.21885024 C16.2825083,7.1943753 14.1050769,6 12,6 C9.89492315,6 7.71749166,7.1943753 5.62403997,9.21885024 C4.86983759,9.94820254 4.18238879,10.7327184 3.57774714,11.5168761 C3.44715924,11.6862352 3.32648802,11.8478224 3.21616526,12 C3.32648802,12.1521776 3.44715924,12.3137648 3.57774714,12.4831239 C4.18238879,13.2672816 4.86983759,14.0517975 5.62403997,14.7811498 C7.71749166,16.8056247 9.89492315,18 12,18 C14.1050769,18 16.2825083,16.8056247 18.37596,14.7811498 C19.1301624,14.0517975 19.8176112,13.2672816 20.4222529,12.4831239 C20.5528408,12.3137648 20.673512,12.1521776 20.7838347,12 C20.673512,11.8478224 20.5528408,11.6862352 20.4222529,11.5168761 Z M12,16 C9.790861,16 8,14.209139 8,12 C8,9.790861 9.790861,8 12,8 C14.209139,8 16,9.790861 16,12 C16,14.209139 14.209139,16 12,16 Z M12,14 C13.1045695,14 14,13.1045695 14,12 C14,10.8954305 13.1045695,10 12,10 C10.8954305,10 10,10.8954305 10,12 C10,13.1045695 10.8954305,14 12,14 Z" fill="currentColor"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="btn-group">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').style.display='none'; document.body.removeChild(this.closest('.modal'));">H·ªßy</button>
                                <button type="submit" class="btn btn-primary">C·∫≠p nh·∫≠t</button>
                            </div>
                        </form>
                    `,
                    size: 'medium',
                    closable: true
                });



                // Add form submission handler
                document.getElementById('editUserForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleEditUser(userId, modal);
                });
            }

            async handleEditUser(userId, modal) {
                const username = document.getElementById('editUserUsername').value.trim();
                const email = document.getElementById('editUserEmail').value.trim() || null;
                const password = document.getElementById('editUserPassword').value.trim();

                if (!username) {
                    Utils.showError('Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p!');
                    return;
                }

                const updateData = {
                    name: username, // Name = username
                    username: username,
                    email: email
                };

                // Only update password if provided
                if (password) {
                    updateData.password = password;
                }

                const result = await authSystem.updateUser(userId, updateData);
                
                if (result.success) {
                    Utils.showSuccess('C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng th√†nh c√¥ng!');
                    modal.style.display = 'none';
                    document.body.removeChild(modal);
                    await this.loadUsers();
                } else {
                    Utils.showError(result.message);
                }
            }

            async deleteUser(userId) {
                const confirmed = await Utils.confirmDialog('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?', 'small');
                if (!confirmed) return;

                const result = await authSystem.deleteUser(userId);
                if (result.success) {
                    Utils.showSuccess('X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng!');
                    await this.loadUsers();
                    await this.loadStatistics();
                } else {
                    Utils.showError(result.message);
                }
            }

            async toggleUserLock(userId) {
                // Get current user info to determine action
                const users = await authSystem.getUsers();
                const user = users.find(u => u.id === userId);
                
                if (!user) {
                    Utils.showError('Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng!');
                    return;
                }

                const isLocked = user.status === false;
                const action = isLocked ? 'm·ªü kh√≥a' : 'kh√≥a';
                const confirmed = await Utils.confirmDialog(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ${action} ng∆∞·ªùi d√πng "${user.name}"?`, 'small');
                
                if (!confirmed) return;

                const result = await authSystem.deleteUser(userId); // Using existing deleteUser function which now toggles status
                if (result.success) {
                    Utils.showSuccess(result.message || `${action} ng∆∞·ªùi d√πng th√†nh c√¥ng!`);
                    await this.loadUsers();
                    await this.loadStatistics();
                } else {
                    Utils.showError(result.message);
                }
            }

            async editField(fieldId) {
                // Get field data first
                const fields = await authSystem.getAllFieldsForAdmin();
                const users = await authSystem.getUsers();
                const field = fields.find(f => f.id === fieldId);
                
                if (!field) {
                    Utils.showError('Kh√¥ng t√¨m th·∫•y tr∆∞·ªùng!');
                    return;
                }

                // Get assigned users
                const assignedUsers = users.filter(user => 
                    user.assignedFields && user.assignedFields.includes(fieldId)
                );

                const modal = Utils.createModal({
                    title: 'Ch·ªânh s·ª≠a Tr∆∞·ªùng D·ªØ Li·ªáu',
                    content: `
                        <form id="editFieldForm">
                            <div class="form-group">
                                <label>T√™n tr∆∞·ªùng</label>
                                <input type="text" id="editFieldName" class="form-input" value="${field.name}" required autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label>M√¥ t·∫£</label>
                                <textarea id="editFieldDescription" class="form-input" rows="3">${field.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Ng∆∞·ªùi d√πng ƒë∆∞·ª£c g√°n (${assignedUsers.length})</label>
                                <button type="button" class="btn btn-secondary" onclick="adminPanel.showFieldAssignmentModal('${fieldId}')" style="width: 100%; margin-top: 5px;">
                                    Qu·∫£n l√Ω g√°n ng∆∞·ªùi d√πng
                                </button>
                                <small style="color: #666;">Hi·ªán t·∫°i: ${assignedUsers.map(u => u.name).join(', ') || 'Ch∆∞a g√°n ai'}</small>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').style.display='none'; document.body.removeChild(this.closest('.modal'));">H·ªßy</button>
                                <button type="submit" class="btn btn-primary">C·∫≠p nh·∫≠t</button>
                            </div>
                        </form>
                    `,
                    size: 'medium',
                    closable: true
                });



                // Add form submission handler
                document.getElementById('editFieldForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleEditField(fieldId, modal);
                });
            }

            async handleEditField(fieldId, modal) {
                const name = document.getElementById('editFieldName').value.trim();
                const description = document.getElementById('editFieldDescription').value.trim();

                if (!name) {
                    Utils.showError('Vui l√≤ng nh·∫≠p t√™n tr∆∞·ªùng!');
                    return;
                }

                const result = await authSystem.updateField(fieldId, { name, description });
                
                if (result.success) {
                    Utils.showSuccess('C·∫≠p nh·∫≠t tr∆∞·ªùng th√†nh c√¥ng!');
                    modal.style.display = 'none';
                    document.body.removeChild(modal);
                    await this.loadFields();
                } else {
                    Utils.showError(result.message);
                }
            }

            async deleteField(fieldId) {
                const confirmed = await Utils.confirmDialog('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tr∆∞·ªùng n√†y? T·∫•t c·∫£ d·ªØ li·ªáu trong tr∆∞·ªùng s·∫Ω b·ªã m·∫•t!', 'small');
                if (!confirmed) return;

                const result = await authSystem.deleteField(fieldId);
                if (result.success) {
                    Utils.showSuccess('X√≥a tr∆∞·ªùng th√†nh c√¥ng!');
                    await this.loadFields();
                    await this.loadStatistics();
                } else {
                    Utils.showError(result.message);
                }
            }

            async deleteData(fieldId, dataId) {
                const confirmed = await Utils.confirmDialog('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d·ªØ li·ªáu n√†y?', 'small');
                if (!confirmed) return;

                const result = await authSystem.removeDataFromField(fieldId, dataId);
                if (result.success) {
                    Utils.showSuccess('X√≥a d·ªØ li·ªáu th√†nh c√¥ng!');
                    await this.loadFieldData(fieldId);
                    await this.loadStatistics();
                } else {
                    Utils.showError(result.message);
                }
            }

            async exportAllDataExcel() {
                Utils.showInfo('ƒêang chu·∫©n b·ªã xu·∫•t d·ªØ li·ªáu Excel...');
                
                try {
                    const fields = await authSystem.getAllFieldsForAdmin();
                    const users = await authSystem.getUsers();
                    
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    
                    // Process each field
                    fields.forEach(field => {
                        if (!field.data || field.data.length === 0) return;
                        
                        // Prepare data for this field
                        const fieldData = field.data.map(item => {
                            const user = users.find(u => u.email === item.addedBy);
                            return {
                                'D·ªØ li·ªáu': item.value,
                                'Ng∆∞·ªùi th√™m': user ? user.name : item.addedBy,
                                'Email': item.addedBy,
                                'Ng√†y th√™m': Utils.formatDate(item.addedAt)
                            };
                        });
                        
                        // Create worksheet for this field
                        const ws = XLSX.utils.json_to_sheet(fieldData);
                        
                        // Auto-size columns based on content (max 50 chars)
                        const columnWidths = this.calculateColumnWidths(fieldData, 50);
                        ws['!cols'] = columnWidths;
                        
                        // Add worksheet to workbook
                        const sheetName = this.sanitizeSheetName(field.name);
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    });
                    
                    // Generate and download file
                    const fileName = `toan_bo_du_lieu_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    Utils.showSuccess('Xu·∫•t d·ªØ li·ªáu Excel th√†nh c√¥ng!');
                } catch (error) {
                    console.error('Export error:', error);
                    Utils.showError('C√≥ l·ªói x·∫£y ra khi xu·∫•t d·ªØ li·ªáu Excel!');
                }
            }

            async exportFieldDataExcel() {
                const fieldId = this.getCustomSelectValue('exportFieldSelectContainer');
                if (!fieldId) {
                    Utils.showError('Vui l√≤ng ch·ªçn tr∆∞·ªùng ƒë·ªÉ xu·∫•t!');
                    return;
                }

                Utils.showInfo('ƒêang chu·∫©n b·ªã xu·∫•t d·ªØ li·ªáu Excel...');
                
                try {
                    const fields = await authSystem.getAllFieldsForAdmin();
                    const users = await authSystem.getUsers();
                    const field = fields.find(f => f.id === fieldId);
                    
                    if (!field) {
                        Utils.showError('Kh√¥ng t√¨m th·∫•y tr∆∞·ªùng!');
                        return;
                    }

                    if (!field.data || field.data.length === 0) {
                        Utils.showWarning('Tr∆∞·ªùng n√†y ch∆∞a c√≥ d·ªØ li·ªáu!');
                        return;
                    }
                    
                    // Prepare data
                    const fieldData = field.data.map(item => {
                        const user = users.find(u => u.email === item.addedBy);
                        return {
                            'D·ªØ li·ªáu': item.value,
                            'Ng∆∞·ªùi th√™m': user ? user.name : item.addedBy,
                            'Email': item.addedBy,
                            'Ng√†y th√™m': Utils.formatDate(item.addedAt)
                        };
                    });
                    
                    // Create workbook and worksheet
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(fieldData);
                    
                    // Auto-size columns
                    const columnWidths = this.calculateColumnWidths(fieldData, 50);
                    ws['!cols'] = columnWidths;
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'D·ªØ li·ªáu');
                    
                    // Generate and download file
                    const fileName = `${this.sanitizeFileName(field.name)}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    Utils.showSuccess('Xu·∫•t d·ªØ li·ªáu Excel th√†nh c√¥ng!');
                } catch (error) {
                    console.error('Export error:', error);
                    Utils.showError('C√≥ l·ªói x·∫£y ra khi xu·∫•t d·ªØ li·ªáu Excel!');
                }
            }

            async exportUserDataExcel() {
                const userFilter = this.getCustomSelectValue('userDataUserSelectContainer');
                const fieldFilter = this.getCustomSelectValue('userDataFieldSelectContainer');
                
                Utils.showInfo('ƒêang chu·∫©n b·ªã xu·∫•t d·ªØ li·ªáu ng∆∞·ªùi d√πng...');
                
                try {
                    const fields = await authSystem.getAllFieldsForAdmin();
                    const users = await authSystem.getUsers();
                    
                    let allUserData = [];
                    
                    // Collect all user-submitted data
                    fields.forEach(field => {
                        if (fieldFilter && field.id !== fieldFilter) return;
                        
                        (field.data || []).forEach(item => {
                            // Skip admin-added data  
                            if (item.addedBy === 'letoan242' || item.addedBy === 'trinhhanh261293@gmail.com') return;
                            
                            if (userFilter && item.addedBy !== userFilter) return;
                            
                            // Find user info
                            const user = users.find(u => u.email === item.addedBy);
                            
                            allUserData.push({
                                'Ng∆∞·ªùi d√πng': user ? user.name : 'Unknown User',
                                'Email': item.addedBy,
                                'Tr∆∞·ªùng': field.name,
                                'D·ªØ li·ªáu': item.value,
                                'Ng√†y th√™m': Utils.formatDate(item.addedAt)
                            });
                        });
                    });

                    if (allUserData.length === 0) {
                        Utils.showWarning('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                        return;
                    }
                    
                    // Create workbook and worksheet
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(allUserData);
                    
                    // Auto-size columns
                    const columnWidths = this.calculateColumnWidths(allUserData, 50);
                    ws['!cols'] = columnWidths;
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'D·ªØ li·ªáu ng∆∞·ªùi d√πng');
                    
                    // Generate and download file
                    const fileName = `du_lieu_nguoi_dung_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    Utils.showSuccess('Xu·∫•t d·ªØ li·ªáu ng∆∞·ªùi d√πng th√†nh c√¥ng!');
                } catch (error) {
                    console.error('Export error:', error);
                    Utils.showError('C√≥ l·ªói x·∫£y ra khi xu·∫•t d·ªØ li·ªáu Excel!');
                }
            }

            // Helper functions for Excel export
            calculateColumnWidths(data, maxWidth = 50) {
                if (!data || data.length === 0) return [];
                
                const keys = Object.keys(data[0]);
                const widths = keys.map(key => {
                    // Calculate width based on header and data
                    let maxLength = key.length;
                    
                    data.forEach(row => {
                        const cellLength = String(row[key] || '').length;
                        if (cellLength > maxLength) {
                            maxLength = cellLength;
                        }
                    });
                    
                    // Limit max width and ensure minimum width
                    return { wch: Math.min(Math.max(maxLength + 2, 10), maxWidth) };
                });
                
                return widths;
            }

            sanitizeSheetName(name) {
                // Remove invalid characters for sheet names
                return name.replace(/[\\\/\*\?\[\]]/g, '_').substring(0, 31);
            }

            sanitizeFileName(name) {
                // Remove invalid characters for file names
                return name.replace(/[<>:"/\\|?*]/g, '_');
            }

            async loadUserDataOptions() {
                // Load users for filter
                const users = await authSystem.getUsers();
                const userOptions = [
                    { value: '', text: 'T·∫•t c·∫£ ng∆∞·ªùi d√πng' },
                    ...users.map(user => ({ 
                        value: user.email, 
                        text: `${user.name} (${user.email})` 
                    }))
                ];

                this.populateCustomSelect('userDataUserSelectContainer', userOptions);

                // Load fields for filter  
                const fields = await authSystem.getAllFieldsForAdmin();
                const fieldOptions = [
                    { value: '', text: 'T·∫•t c·∫£ tr∆∞·ªùng' },
                    ...fields.map(field => ({ 
                        value: field.id, 
                        text: field.name 
                    }))
                ];

                this.populateCustomSelect('userDataFieldSelectContainer', fieldOptions);

                // Load initial data
                await this.loadUserData();
            }

            async loadUserData() {
                const userFilter = this.getCustomSelectValue('userDataUserSelectContainer');
                const fieldFilter = this.getCustomSelectValue('userDataFieldSelectContainer');
                
                const fields = await authSystem.getAllFieldsForAdmin();
                const users = await authSystem.getUsers();
                
                let allUserData = [];
                let todayData = 0;
                let contributingUsers = new Set();
                let totalContributors = new Set(); // New: track all contributors ever
                const today = new Date().toDateString();

                // Collect all user-submitted data
                fields.forEach(field => {
                    if (fieldFilter && field.id !== fieldFilter) return;
                    
                    (field.data || []).forEach(item => {
                        // Skip admin-added data  
                        if (item.addedBy === 'letoan242' || item.addedBy === 'trinhhanh261293@gmail.com') return;
                        
                        // Add to total contributors regardless of current filter
                        totalContributors.add(item.addedBy);
                        
                        if (userFilter && item.addedBy !== userFilter) return;
                        
                        // Find user info
                        const user = users.find(u => u.email === item.addedBy);
                        
                        allUserData.push({
                            ...item,
                            fieldName: field.name,
                            fieldId: field.id,
                            userName: user ? (user.username || user.name) : 'Unknown User'
                        });
                        
                        contributingUsers.add(item.addedBy);
                        
                        if (new Date(item.addedAt).toDateString() === today) {
                            todayData++;
                        }
                    });
                });

                // Sort by date (newest first)
                allUserData.sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt));

                // Update statistics
                Utils.animateNumber(document.getElementById('userDataTotal'), 0, allUserData.length);
                Utils.animateNumber(document.getElementById('userDataToday'), 0, todayData);
                Utils.animateNumber(document.getElementById('userDataUsers'), 0, contributingUsers.size);
                Utils.animateNumber(document.getElementById('userDataContributors'), 0, totalContributors.size);

                // Display table
                const container = document.getElementById('userDataTableContainer');
                
                if (allUserData.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Kh√¥ng c√≥ d·ªØ li·ªáu n√†o.</p>';
                    return;
                }

                const columns = [
                    { key: 'userName', title: 'Ng∆∞·ªùi d√πng' },
                    { key: 'fieldName', title: 'Tr∆∞·ªùng' },
                    { key: 'value', title: 'D·ªØ li·ªáu' },
                    { key: 'addedAt', title: 'Ng√†y th√™m', type: 'date' }
                ];

                const options = {
                    actions: (data) => `
                        <button class="btn btn-danger" onclick="adminPanel.removeUserData('${data.fieldId}', '${data.id}')" style="padding: 5px 10px;">üóëÔ∏è</button>
                    `,
                    pagination: true,
                    itemsPerPage: 10
                };

                const table = Utils.createTable(allUserData, columns, options);
                container.innerHTML = '<h3>D·ªØ li·ªáu ƒë∆∞·ª£c th√™m b·ªüi ng∆∞·ªùi d√πng:</h3>';
                container.appendChild(table);
            }

            async removeUserData(fieldId, dataId) {
                const confirmed = await Utils.confirmDialog('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d·ªØ li·ªáu n√†y?', 'small');
                if (!confirmed) return;

                const result = await authSystem.removeDataFromField(fieldId, dataId);
                if (result.success) {
                    Utils.showSuccess('X√≥a d·ªØ li·ªáu th√†nh c√¥ng!');
                    await this.loadUserData();
                    await this.loadStatistics();
                } else {
                    Utils.showError(result.message);
                }
            }

            updateUI() {
                const user = authSystem.getCurrentUser();
                if (user) {
                    document.getElementById('userInfo').textContent = `üëã ${user.name}`;
                }
            }

            updateStatisticsOptimistic(type, change) {
                try {
                    if (type === 'user') {
                        const userElement = document.getElementById('totalUsers');
                        const currentValue = parseInt(userElement.textContent) || 0;
                        const newValue = Math.max(0, currentValue + change);
                        Utils.animateNumber(userElement, currentValue, newValue);
                    } else if (type === 'field') {
                        const fieldElement = document.getElementById('totalFields');
                        const currentValue = parseInt(fieldElement.textContent) || 0;
                        const newValue = Math.max(0, currentValue + change);
                        Utils.animateNumber(fieldElement, currentValue, newValue);
                    } else if (type === 'data') {
                        const dataElement = document.getElementById('totalData');
                        const currentValue = parseInt(dataElement.textContent) || 0;
                        const newValue = Math.max(0, currentValue + change);
                        Utils.animateNumber(dataElement, currentValue, newValue);
                    }
                } catch (error) {
                    console.debug('Optimistic stats update error:', error);
                }
            }

            addUserToTableOptimistic(user) {
                try {
                    const container = document.getElementById('usersTableContainer');
                    const table = container.querySelector('table tbody');
                    
                    if (!table) return; // Table not loaded yet
                    
                    // Create new row
                    const row = document.createElement('tr');
                    row.style.background = 'rgba(76, 175, 80, 0.1)'; // Green highlight for new item
                    
                    const isLocked = user.status === false;
                    const statusBadge = isLocked ? 
                        '<span class="status-badge status-locked">üîí B·ªã kh√≥a</span>' : 
                        '<span class="status-badge status-active">‚úÖ Ho·∫°t ƒë·ªông</span>';
                    const lockBtnClass = isLocked ? 'btn-success' : 'btn-warning';
                    const lockBtnText = isLocked ? 'üîì M·ªü kh√≥a' : 'üîí Kh√≥a';
                    
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email || ''}</td>
                        <td>${(user.assignedFields || []).length} tr∆∞·ªùng</td>
                        <td>${statusBadge}</td>
                        <td>${Utils.formatDate(user.createdAt, 'dateShort')}</td>
                        <td>${user.createdBy}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="adminPanel.editUser('${user.id}')" style="margin-right: 5px; padding: 5px 10px;">‚úèÔ∏è</button>
                            <button class="btn ${lockBtnClass}" onclick="adminPanel.toggleUserLock('${user.id}')" style="padding: 5px 10px;">${lockBtnText}</button>
                        </td>
                    `;
                    
                    // Insert at the top (newest first)
                    table.insertBefore(row, table.firstChild);
                    
                    // Remove highlight after animation
                    setTimeout(() => {
                        row.style.background = '';
                    }, 2000);
                } catch (error) {
                    console.debug('Optimistic table update error:', error);
                }
            }

            addFieldToTableOptimistic(field) {
                try {
                    const container = document.getElementById('fieldsTableContainer');
                    const table = container.querySelector('table tbody');
                    
                    if (!table) return; // Table not loaded yet
                    
                    // Create new row
                    const row = document.createElement('tr');
                    row.style.background = 'rgba(76, 175, 80, 0.1)'; // Green highlight for new item
                    row.innerHTML = `
                        <td>${field.name}</td>
                        <td>${field.description || ''}</td>
                        <td>0 m·ª•c</td>
                        <td>
                            <button class="btn btn-secondary" onclick="adminPanel.showFieldAssignmentModal('${field.id}')" style="padding: 5px 10px;">0 ng∆∞·ªùi</button>
                        </td>
                        <td>${Utils.formatDate(field.createdAt, 'dateShort')}</td>
                        <td>${field.createdBy}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="adminPanel.editField('${field.id}')" style="margin-right: 5px; padding: 5px 10px;">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="adminPanel.deleteField('${field.id}')" style="padding: 5px 10px;">üóëÔ∏è</button>
                        </td>
                    `;
                    
                    // Insert at the top (newest first)
                    table.insertBefore(row, table.firstChild);
                    
                    // Remove highlight after animation
                    setTimeout(() => {
                        row.style.background = '';
                    }, 2000);
                } catch (error) {
                    console.debug('Optimistic field table update error:', error);
                }
            }
        }

        // Make AdminPanel globally available
        window.AdminPanel = AdminPanel;

        // Initialize admin panel
        let adminPanel;
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for auth system to be ready
            let attempts = 0;
            while (!window.authSystem && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 50));
                attempts++;
            }
            
            adminPanel = new AdminPanel();
            window.adminPanel = adminPanel;
        });
    </script>

    <style>
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: rgba(255, 179, 128, 0.2);
            color: #ff6b35;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-btn.active,
        .tab-btn:hover {
            background: linear-gradient(135deg, #ff6b35 0%, #ff9a56 100%);
            color: white;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Field-specific error messages */
        .field-error {
            color: #d32f2f;
            font-size: 12px;
            margin-top: 5px;
            display: none;
            min-height: 16px;
        }

        /* User item styling for field assignment */
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .user-item:hover {
            background: rgba(255, 179, 128, 0.1);
        }

        .user-item span {
            flex: 1;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .tab-navigation {
                flex-direction: column;
            }
            
            .card-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats {
                flex-direction: column;
            }
        }

        /* Status badges for user status */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-active {
            background-color: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-locked {
            background-color: rgba(244, 67, 54, 0.1);
            color: #c62828;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        /* Password Toggle Styling */
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-container .form-input {
            padding-right: 45px;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #666;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle:hover {
            color: #ff6b35;
        }

        .password-icon {
            width: 20px;
            height: 20px;
        }
    </style>
</body>
</html> 
