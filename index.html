<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng nh·∫≠p - H·ªá th·ªëng Ki·ªÉm tra Tr√πng l·∫∑p</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card slide-up">
            <h1>ƒêƒÉng nh·∫≠p</h1>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng h·ªá th·ªëng
            </p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email ho·∫∑c T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="email" class="form-input" placeholder="Nh·∫≠p email ho·∫∑c t√™n ƒëƒÉng nh·∫≠p">
                    <div class="error-message" id="emailError"></div>
                </div>
                
                <div class="form-group">
                    <label for="password">M·∫≠t kh·∫©u</label>
                    <div class="password-input-container">
                        <input type="password" id="password" class="form-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                        <button type="button" class="password-toggle" onclick="togglePassword('password', this)">
                            <svg class="password-icon hide-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 4L9.87868 9.87868M20 20L14.1213 14.1213M9.87868 9.87868C9.33579 10.4216 9 11.1716 9 12C9 13.6569 10.3431 15 12 15C12.8284 15 13.5784 14.6642 14.1213 14.1213M9.87868 9.87868L14.1213 14.1213M6.76821 6.76821C4.72843 8.09899 2.96378 10.026 2 11.9998C3.74646 15.5764 8.12201 19 11.9998 19C13.7376 19 15.5753 18.3124 17.2317 17.2317M9.76138 5.34717C10.5114 5.12316 11.2649 5 12.0005 5C15.8782 5 20.2531 8.42398 22 12.0002C21.448 13.1302 20.6336 14.2449 19.6554 15.2412" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <svg class="password-icon show-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                                <path fill-rule="evenodd" d="M12,4 C14.7275481,4 17.3356792,5.4306247 19.76629,7.78114976 C20.5955095,8.58304746 21.3456935,9.43915664 22.0060909,10.2956239 C22.4045936,10.8124408 22.687526,11.2189945 22.8424353,11.4612025 L23.1870348,12 L22.8424353,12.5387975 C22.687526,12.7810055 22.4045936,13.1875592 22.0060909,13.7043761 C21.3456935,14.5608434 20.5955095,15.4169525 19.76629,16.2188502 C17.3356792,18.5693753 14.7275481,20 12,20 C9.27245185,20 6.66432084,18.5693753 4.23371003,16.2188502 C3.40449054,15.4169525 2.65430652,14.5608434 1.99390911,13.7043761 C1.59540638,13.1875592 1.31247398,12.7810055 1.15756471,12.5387975 L0.812965202,12 L1.15756471,11.4612025 C1.31247398,11.2189945 1.59540638,10.8124408 1.99390911,10.2956239 C2.65430652,9.43915664 3.40449054,8.58304746 4.23371003,7.78114976 C6.66432084,5.4306247 9.27245185,4 12,4 Z M20.4222529,11.5168761 C19.8176112,10.7327184 19.1301624,9.94820254 18.37596,9.21885024 C16.2825083,7.1943753 14.1050769,6 12,6 C9.89492315,6 7.71749166,7.1943753 5.62403997,9.21885024 C4.86983759,9.94820254 4.18238879,10.7327184 3.57774714,11.5168761 C3.44715924,11.6862352 3.32648802,11.8478224 3.21616526,12 C3.32648802,12.1521776 3.44715924,12.3137648 3.57774714,12.4831239 C4.18238879,13.2672816 4.86983759,14.0517975 5.62403997,14.7811498 C7.71749166,16.8056247 9.89492315,18 12,18 C14.1050769,18 16.2825083,16.8056247 18.37596,14.7811498 C19.1301624,14.0517975 19.8176112,13.2672816 20.4222529,12.4831239 C20.5528408,12.3137648 20.673512,12.1521776 20.7838347,12 C20.673512,11.8478224 20.5528408,11.6862352 20.4222529,11.5168761 Z M12,16 C9.790861,16 8,14.209139 8,12 C8,9.790861 9.790861,8 12,8 C14.209139,8 16,9.790861 16,12 C16,14.209139 14.209139,16 12,16 Z M12,14 C13.1045695,14 14,13.1045695 14,12 C14,10.8954305 13.1045695,10 12,10 C10.8954305,10 10,10.8954305 10,12 C10,13.1045695 10.8954305,14 12,14 Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                    <div class="error-message" id="passwordError"></div>
                </div>
                
                <button type="submit" id="loginBtn" class="btn btn-primary btn-full">
                    ƒêƒÉng nh·∫≠p
                </button>
            </form>
        </div>
    </div>

    <!-- Fast Loading Modal -->
    <div id="loadingModal" class="loading-modal">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <p id="loadingText">ƒêang kh·ªüi t·∫°o...</p>
        </div>
    </div>

    <!-- Application Scripts with optimized loading -->
    <script src="js/utils.js"></script>
    <script type="module">
        // Optimized module imports with timeout fallback
        const MODULE_TIMEOUT = 10000; // 10 seconds
        
        // Fast module loader with error handling
        async function loadModules() {
            try {
                const loadPromise = Promise.all([
                    import('./js/config.js'),
                    import('./js/auth.js')
                ]);
                
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Module load timeout')), MODULE_TIMEOUT);
                });
                
                const [configModule, authModule] = await Promise.race([loadPromise, timeoutPromise]);
                
                // Make them globally available
                window.configManager = configModule.configManager;
                window.rateLimiter = configModule.rateLimiter;
                window.authSystem = authModule.authSystem;
                
                return true;
            } catch (error) {
                console.error('Failed to load modules:', error);
                hideLoadingModal();
                showError('L·ªói t·∫£i ·ª©ng d·ª•ng. Vui l√≤ng th·ª≠ l·∫°i.');
                return false;
            }
        }

        // Optimized utility functions
        function clearErrors() {
            document.getElementById('emailError').textContent = '';
            document.getElementById('passwordError').textContent = '';
        }

        function showFieldError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + 'Error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function showLoadingModal(text = 'ƒêang x·ª≠ l√Ω...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingModal').style.display = 'flex';
        }

        function hideLoadingModal() {
            document.getElementById('loadingModal').style.display = 'none';
        }

        function showError(message) {
            alert(message); // Simple fallback error display
        }

        function showLockedAccountModal(message) {
            const modal = document.createElement('div');
            modal.className = 'locked-account-modal';
            modal.innerHTML = `
                <div class="locked-account-content">
                    <div class="locked-account-icon">üîí</div>
                    <h3>T√†i kho·∫£n b·ªã kh√≥a</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="this.closest('.locked-account-modal').remove()">
                        ƒê√£ hi·ªÉu
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const hideIcon = button.querySelector('.hide-icon');
            const showIcon = button.querySelector('.show-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                hideIcon.style.display = 'none';
                showIcon.style.display = 'block';
            } else {
                input.type = 'password';
                hideIcon.style.display = 'block';
                showIcon.style.display = 'none';
            }
        }

        // Fast authentication system checker
        async function waitForAuthSystem(maxAttempts = 100) {
            for (let i = 0; i < maxAttempts; i++) {
                if (window.authSystem) return true;
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            return false;
        }

        // Optimized initialization
        async function initializeApp() {
            showLoadingModal('ƒêang t·∫£i ·ª©ng d·ª•ng...');
            
            // Load modules
            const modulesLoaded = await loadModules();
            if (!modulesLoaded) return;
            
            showLoadingModal('ƒêang kh·ªüi t·∫°o b·∫£o m·∫≠t...');
            
            // Wait for auth system
            const authReady = await waitForAuthSystem();
            if (!authReady) {
                hideLoadingModal();
                showError('Kh√¥ng th·ªÉ kh·ªüi t·∫°o h·ªá th·ªëng x√°c th·ª±c.');
                return;
            }

            hideLoadingModal();
            
            // Check if user is already logged in
            if (authSystem.isLoggedIn()) {
                authSystem.redirectToAppropriatePanel();
                return;
            }

            // Setup form handlers
            setupFormHandlers();
        }

        function setupFormHandlers() {
            const loginForm = document.getElementById('loginForm');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');

            // Handle form submission
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                clearErrors();
                
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();

                // Client-side validation
                let hasErrors = false;

                if (!email) {
                    showFieldError('email', 'Vui l√≤ng nh·∫≠p email ho·∫∑c t√™n ƒëƒÉng nh·∫≠p');
                    hasErrors = true;
                }

                if (!password) {
                    showFieldError('password', 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u');
                    hasErrors = true;
                }

                if (hasErrors) return;

                showLoadingModal('ƒêang x√°c th·ª±c t√†i kho·∫£n...');

                try {
                    const result = await authSystem.login(email, password);
                    
                    if (result.success) {
                        showLoadingModal('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
                        
                        // Fast redirect
                        setTimeout(() => {
                            hideLoadingModal();
                            authSystem.redirectToAppropriatePanel();
                        }, 300); // Reduced from 500ms
                    } else {
                        hideLoadingModal();
                        
                        // Ki·ªÉm tra n·∫øu user b·ªã kh√≥a
                        if (result.isLocked) {
                            showLockedAccountModal(result.message);
                            return;
                        }
                        
                        // Show specific field errors
                        if (result.field === 'email') {
                            showFieldError('email', result.message);
                        } else if (result.field === 'password') {
                            showFieldError('password', result.message);
                        } else {
                            showFieldError('email', result.message);
                        }
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    hideLoadingModal();
                    showFieldError('email', 'C√≥ l·ªói x·∫£y ra khi ƒëƒÉng nh·∫≠p. Vui l√≤ng th·ª≠ l·∫°i!');
                }
            });

            // Clear errors when user starts typing
            emailInput.addEventListener('input', () => {
                document.getElementById('emailError').textContent = '';
            });

            passwordInput.addEventListener('input', () => {
                document.getElementById('passwordError').textContent = '';
            });

            // Add enter key handling
            emailInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    passwordInput.focus();
                }
            });

            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginForm.dispatchEvent(new Event('submit'));
                }
            });

            // Auto focus on email input
            emailInput.focus();
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Fallback initialization if DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            // DOMContentLoaded will handle it
        } else {
            // DOM is already loaded
            setTimeout(initializeApp, 0);
        }
    </script>

    <style>
        /* Error Messages */
        .error-message {
            color: #d32f2f;
            font-size: 12px;
            margin-top: 5px;
            display: none;
            min-height: 16px;
        }

        .form-input.error {
            border-color: #f44336;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1);
        }

        /* Optimized Loading Modal */
        .loading-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .loading-modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            min-width: 300px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b35;
            border-radius: 50%;
            animation: spin 0.8s linear infinite; /* Faster spin */
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingText {
            color: #666;
            font-weight: 500;
            margin: 0;
        }
        
        /* Performance optimizations */
        * {
            box-sizing: border-box;
        }
        
        .auth-container {
            will-change: transform;
        }
        
        .slide-up {
            animation: slideUp 0.4s ease-out; /* Faster animation */
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Locked Account Modal */
        .locked-account-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .locked-account-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            animation: scaleIn 0.3s ease-out;
        }

        .locked-account-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .locked-account-content h3 {
            color: #d32f2f;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .locked-account-content p {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { 
                opacity: 0;
                transform: scale(0.8);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Password Toggle Styling */
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-container .form-input {
            padding-right: 45px;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #666;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle:hover {
            color: #ff6b35;
        }

        .password-icon {
            width: 20px;
            height: 20px;
        }
    </style>
</body>
</html>